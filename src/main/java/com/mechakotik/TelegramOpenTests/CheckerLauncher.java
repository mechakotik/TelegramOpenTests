package com.mechakotik.TelegramOpenTests;

import java.util.Locale;
import java.util.Scanner;

public class CheckerLauncher {
    public static class CheckResult {
        String verdict;
        double score;

        public CheckResult(String verdict, double score) {
            this.verdict = verdict;
            this.score = score;
        }
    }

    int testNumber;
    String outputPath;

    public CheckResult run(String[] commandTemplate, int testNumber, String outputPath) {
        this.testNumber = testNumber;
        this.outputPath = outputPath;

        try {
            return tryRun(commandTemplate);
        }
        catch(Exception e) {
            System.out.println("Checker error: " + e);
            return new CheckResult("Crash", 0);
        }
    }

    public CheckResult tryRun(String[] commandTemplate) throws Exception {
        String[] command = generateCommand(commandTemplate);
        Process process = new ProcessBuilder(command).start();
        Scanner scanner = new Scanner(process.getInputStream()).useLocale(Locale.US);
        return new CheckResult(scanner.nextLine(), scanner.nextDouble());
    }

    private String[] generateCommand(String[] commandTemplate) {
        String[] command = new String[commandTemplate.length];
        for(int i = 0; i < commandTemplate.length; i ++) {
            command[i] = fillTemplate(commandTemplate[i]);
        }
        return command;
    }

    private String fillTemplate(String commandTemplate) {
        String command = "", template = "";
        boolean replacing = false;

        for(char c : commandTemplate.toCharArray()) {
            if(c == '%') {
                if(replacing) {
                    if(template.equals("test")) {
                        command += testNumber;
                    }
                    else if(template.equals("output")) {
                        command += outputPath;
                    }
                    else {
                        command += "%" + template + "%";
                    }
                    template = "";
                    replacing = false;
                }
                else {
                    replacing = true;
                }
            }
            else {
                if(replacing) {
                    template += c;
                }
                else {
                    command += c;
                }
            }
        }

        return command;
    }
}
