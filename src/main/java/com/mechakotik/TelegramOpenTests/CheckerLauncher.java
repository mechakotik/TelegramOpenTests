package com.mechakotik.TelegramOpenTests;

import java.util.Locale;
import java.util.Scanner;

public class CheckerLauncher {
    public static class CheckResult {
        String verdict;
        double score;

        public CheckResult(String verdict, double score) {
            this.verdict = verdict;
            this.score = score;
        }
    }

    public CheckResult run(String commandTemplate, int testNumber, String outputPath) {
        try {
            return tryRun(commandTemplate, testNumber, outputPath);
        }
        catch(Exception e) {
            System.out.println("Checker error: " + e);
            return new CheckResult("Crash", 0);
        }
    }

    public CheckResult tryRun(String commandTemplate, int testNumber, String outputPath) throws Exception {
        String command = generateCommand(commandTemplate, testNumber, outputPath);
        Scanner scanner = new Scanner(Runtime.getRuntime().exec(command).getInputStream()).useLocale(Locale.US);
        return new CheckResult(scanner.nextLine(), scanner.nextDouble());
    }

    private String generateCommand(String commandTemplate, int testNumber, String outputPath) {
        String command = "", template = "";
        boolean replacing = false;

        for(char c : commandTemplate.toCharArray()) {
            if(c == '%') {
                if(replacing) {
                    if(template.equals("test")) {
                        command += testNumber;
                    }
                    else if(template.equals("output")) {
                        command += outputPath;
                    }
                    else {
                        command += "%" + template + "%";
                    }
                    template = "";
                    replacing = false;
                }
                else {
                    replacing = true;
                }
            }
            else {
                if(replacing) {
                    template += c;
                }
                else {
                    command += c;
                }
            }
        }

        return command;
    }
}
