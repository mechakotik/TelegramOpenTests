package com.mechakotik.TelegramOpenTests;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.GetFile;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Document;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.tomlj.Toml;
import org.tomlj.TomlParseResult;

import java.io.*;
import java.nio.file.Paths;
import java.util.*;

public class OpenTestsBot extends TelegramLongPollingBot {
    UserManager users;
    TomlParseResult options;
    int numTests;

    public OpenTestsBot() throws Exception {
        options = Toml.parse(Paths.get("config.toml"));
        options.errors().forEach(error -> System.err.println(error.toString()));

        numTests = Math.toIntExact(options.getLong("problem.num_tests"));
        users = new UserManager(numTests);
        users.loadFromFile();
    }

    @Override
    public String getBotUsername() {
        return options.getString("bot.username");
    }

    @Override
    public String getBotToken() {
        return options.getString("bot.token");
    }

    public void onUpdateReceived(Update update) {
        try {
            handleUpdate(update);
        } catch (Exception e) {
            System.out.println("Exception thrown: " + e);
        }
    }

    HashSet<String> fileIdSet = new HashSet<>();
    int lastMessageId = 0;

    HashSet<Long> registeringSet = new HashSet<>();

    private void handleUpdate(Update update) throws Exception {
        var message = update.getMessage();
        var user = message.getFrom();
        var id = user.getId();

        switch(users.getUserState(id)) {
            case UNREGISTERED:
                sendText(id, "Введите ник (от 2 до 12 символов, без пробелов)");
                users.setUserState(id, UserManager.UserState.ENTERING_NAME);
                break;

            case ENTERING_NAME:
                if(message.hasText() && users.isCorrectName(message.getText())) {
                    users.setUserName(id, message.getText());
                    users.setUserState(id, UserManager.UserState.DEFAULT);
                    sendHelp(id);
                }
                else {
                    sendText(id, "Введите ник (от 2 до 12 символов, без пробелов)");
                }
                break;

            case DEFAULT:
                lastMessageId = message.getMessageId();
                if(message.hasDocument()) {
                    processFile(id, message.getDocument());
                }
                else {
                    processCommand(id, message.getText());
                }
                break;
        }

        saveUsersList();
    }

    private void processCommand(Long id, String command) throws Exception {
        switch(command) {
            case "/help":
                sendHelp(id);
                break;
            case "/standings":
                sendStandings(id);
                break;
            case "/score":
                sendScore(id);
                break;
            default:
                sendText(id, "Неизвестная команда");
        }
    }

    private void processFile(Long id, Document document) throws Exception {
        var fileUniqueId = document.getFileUniqueId();
        if(fileIdSet.contains(fileUniqueId)) {
            sendReply(id, "Вы уже посылали этот файл");
            return;
        }
        fileIdSet.add(fileUniqueId);
        if(document.getFileSize() > 2e7) {
            sendReply(id, "Размер файла не должен превышать 20 Мб");
            return;
        }

        GetFile getFile = new GetFile();
        getFile.setFileId(document.getFileId());
        String filePath = execute(getFile).getFilePath();
        File file = downloadFile(filePath);
        checkOutputFile(file.getPath(), document.getFileName(), id);
    }

    private void sendText(Long id, String text) throws Exception {
        SendMessage sm = SendMessage.builder().chatId(id.toString()).text(text).parseMode("HTML").build();
        execute(sm);
    }

    private void sendReply(Long id, String text) throws Exception {
        SendMessage sm = SendMessage.builder().chatId(id.toString()).text(text).replyToMessageId(lastMessageId).parseMode("HTML").build();
        execute(sm);
    }

    private void sendStandings(Long userId) throws Exception {
        var standings = users.getStandings();
        String message = "<code>";
        for(int i = 0; i < standings.length; i ++) {
            message += (i + 1) + ". ";
            if(i + 1 <= 9) {
                message += " ";
            }
            message += standings[i].name;
            for(int j = 0; j < 16 - standings[i].name.length(); j ++) {
                message += " ";
            }
            message += String.format(Locale.ROOT, "%.3f", standings[i].score) + "\n";
        }
        message += "</code>";
        sendText(userId, message);
    }

    private void sendScore(Long userId) throws Exception {
        String message = "<code>";
        double scoreSum = 0;
        for(int i = 0; i < numTests; i ++) {
            message += (i + 1);
            message += ": ";
            if(i + 1 <= 9) {
                message += " ";
            }
            double score = users.getTestScore(userId, i);
            scoreSum += score;
            message += String.format(Locale.ROOT, "%.3f", score);
            message += "\n";
        }
        message += "\nΣ:  " + String.format(Locale.ROOT, "%.3f", scoreSum);
        message += "</code>";
        sendText(userId, message);
    }

    private void checkOutputFile(String path, String filename, Long userId) throws Exception {
        int testNumber = numTests;
        while(testNumber >= 1 && !filename.contains(Integer.toString(testNumber))) {
            testNumber -= 1;
        }
        if(testNumber == 0) {
            sendReply(userId, "Имя выходного файла должно содержать номер теста. Например, output1.txt");
            return;
        }
        testNumber --;

        var parsedCommand = options.getArray("problem.checker_command");
        String[] command = new String[parsedCommand.size()];
        for(int i = 0; i < parsedCommand.size(); i ++) {
            command[i] = parsedCommand.getString(i);
        }
        var result = new CheckerLauncher().run(command, testNumber + 1, path);

        users.updateTestScore(userId, testNumber, result.score);
        String message = "Вердикт: " + result.verdict +
                         "\nБаллы за тест: " + String.format(Locale.ROOT, "%.3f", result.score);
        sendReply(userId, message);
    }

    private void sendHelp(Long id) throws Exception {
        String text = "<a href=" + '"' + options.getString("statement_url") + '"' + ">Условие</a>\n";
        text += "<a href=" + '"' + options.getString("tests_archive_url") + '"' + ">Архив с тестами</a>\n";
        text += "\nСписок команд:\n";
        text += "/help - условие, список команд\n";
        text += "/score - баллы по всем тестам\n";
        text += "/standings - таблица";
        sendText(id, text);
    }

    long lastTime = 0L;

    private void saveUsersList() throws Exception {
        Date date = new Date();
        long currentTime = date.getTime();
        if(currentTime / 300000 != lastTime / 300000) {
            users.saveToFile();
        }
    }
}
